// شلیک دشمن
function enemyShoot(enemy){
    enemyBullets.push({x:enemy.x+enemy.w/2-5, y:enemy.y+enemy.h, w:10, h:20, speed:6});
}

// آپدیت بازی
function update(){
    frame++; 
    if(frame%100===0) spawnEnemy();

    if(startTime){
        let elapsed = (Date.now() - startTime)/1000;

        // افزایش سختی مرحله‌ای
        if((elapsed>0 && elapsed<=10) && lastDifficultyTime==0){
            enemySpeedBase += 0.5; enemyCountBase += 1; lastDifficultyTime=1;
        } else if((elapsed>10 && elapsed<=30) && lastDifficultyTime==1){
            enemySpeedBase += 0.5; enemyCountBase += 1; lastDifficultyTime=2;
        } else if(elapsed>30 && Math.floor(elapsed/10)+1 > lastDifficultyTime){
            enemySpeedBase += 0.5; enemyCountBase += 1; lastDifficultyTime = Math.floor(elapsed/10)+1;
        }

        if(elapsed>10) enemyShotEnable = true;
    }

    // حرکت بازیکن
    if(moveLeft) player.x-=player.speed;
    if(moveRight) player.x+=player.speed;
    if(player.x<0) player.x=0; 
    if(player.x+player.w>canvas.width) player.x=canvas.width-player.w;

    // حرکت گلوله‌ها
    bullets.forEach((b,i)=>{ b.y-=b.speed; if(b.y+b.h<0) bullets.splice(i,1); });

    // حرکت دشمن‌ها و برخورد با بازیکن و تیر بازیکن
    for(let i=enemies.length-1; i>=0; i--){
        let en = enemies[i];
        en.y += en.speed;

        // برخورد با بازیکن
        if(en.x < player.x + player.w && en.x + en.w > player.x &&
           en.y < player.y + player.h && en.y + en.h > player.y){
            player.lives--;
            enemies.splice(i,1);
            if(player.lives <= 0){
                loadingScreen.style.display='flex';
                loadingText.innerText='بازی مجدد';
                startBtn.style.display='block';
            }
            continue;
        }

        // برخورد گلوله بازیکن با دشمن
        for(let j=bullets.length-1; j>=0; j--){
            let b = bullets[j];
            if(b.x<en.x+en.w && b.x+b.w>en.x && b.y<en.y+en.h && b.y+b.h>en.y){
                explosions.push({x:en.x,y:en.y,w:en.w,h:en.h,frame:0});
                enemies.splice(i,1);
                bullets.splice(j,1);
                score++;
                break;
            }
        }

        // شلیک دشمن
        if(enemyShotEnable && Math.random()<0.01){ enemyShoot(en); }
    }

    // حرکت و برخورد تیر دشمن با بازیکن
    for(let i=enemyBullets.length-1; i>=0; i--){
        let eb = enemyBullets[i];
        eb.y += eb.speed;
        if(eb.y>canvas.height){ enemyBullets.splice(i,1); continue; }
        if(eb.x < player.x + player.w && eb.x + eb.w > player.x &&
           eb.y < player.y + player.h && eb.y + eb.h > player.y){
            player.lives--;
            enemyBullets.splice(i,1);
            if(player.lives <=0){
                loadingScreen.style.display='flex';
                loadingText.innerText='بازی مجدد';
                startBtn.style.display='block';
            }
        }
    }

    // انفجار
    for(let i=explosions.length-1;i>=0;i++){
        explosions[i].frame++;
        if(explosions[i].frame>20) explosions.splice(i,1);
    }

    draw();
    if(player.lives>0) requestAnimationFrame(update);
}

// رسم
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);

    // خط‌چین پشت بازیکن
    ctx.strokeStyle="yellow";
    ctx.setLineDash([5,5]);
    ctx.strokeRect(0, player.y+player.h+50, canvas.width, 20);
    ctx.setLineDash([]);

    // بازیکن
    ctx.save();
    ctx.translate(player.x+player.w/2,player.y+player.h/2);
    ctx.rotate(-Math.PI/2);
    ctx.drawImage(playerImg,-player.w/2,-player.h/2,player.w,player.h);
    ctx.restore();

    bullets.forEach(b=>ctx.drawImage(bulletImg,b.x,b.y,b.w,b.h));
    enemyBullets.forEach(eb=>{ ctx.fillStyle="red"; ctx.fillRect(eb.x,eb.y,eb.w,eb.h); });
    enemies.forEach(en=>ctx.drawImage(enemyImg,en.x,en.y,en.w,en.h));
    explosions.forEach(ex=>ctx.drawImage(boomImg,ex.x,ex.y,ex.w,ex.h));

    ctx.fillStyle="#fff"; ctx.font="20px Arial"; ctx.fillText("Score: "+score,10,30);for(let i=0;i<5;i++){
        ctx.fillStyle = i<player.lives?"red":"black";
        ctx.fillRect(10+i*25,50,20,20);
    }
}
</script>

</body>
</html>
